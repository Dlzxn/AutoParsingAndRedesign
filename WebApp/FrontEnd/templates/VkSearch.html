{% extends 'base.html' %}

{% block styles %}
<link rel="stylesheet" href="WebApp/FrontEnd/styles/vksearch.css">
<style>
    /* –î–æ–±–∞–≤–∏–º —Å—Ç–∏–ª—å –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏, —á—Ç–æ–±—ã –æ–Ω –±—ã–ª –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º—ã–º */
    .results-container {
        max-height: 70vh; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ */
        overflow-y: auto; /* –î–æ–±–∞–≤–ª—è–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É */
        padding: 10px;
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script src="WebApp/FrontEnd/scr/VKapp.js"></script>
<script>
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
    const scrollToResults = () => {
        const resultsContainer = document.getElementById('results');
        resultsContainer.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });
    };

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–ª–∏ —Å–∫—Ä—ã–≤–∞–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const toggleLoading = (show) => {
        loadingContainer.style.display = show ? 'block' : 'none';
        searchInput.disabled = show;
        searchButton.disabled = show;
    };

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
    const showError = (message) => {
        resultsContainer.innerHTML = `<div class="error-message">‚ùå ${message}</div>`;
    };

    // –°–æ–∑–¥–∞–µ—Ç –±–ª–æ–∫ —Å –≤–∏–¥–µ–æ
    const createResultItem = ({ title, url }) => {
        const item = document.createElement('div');
        item.className = 'result-item';

        // –ò–∑–≤–ª–µ–∫–∞–µ–º ID –≤–∏–¥–µ–æ –∏–∑ URL
        const match = url.match(/video(\d+)_(\d+)/);
        let embedUrl = '';
        if (match) {
            const ownerId = match[1];
            const videoId = match[2];

            // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ iframe
            embedUrl = `https://vk.com/video_ext.php?oid=${ownerId}&id=${videoId}`;
        }

        item.innerHTML = `
            <div class="video-box">
                <h3>${title || url}</h3>
                <iframe src="${embedUrl}" width="640" height="360" frameborder="0" allowfullscreen="true"></iframe>
            </div>
        `;

        return item;
    };

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
    const performSearch = async (query) => {
        toggleLoading(true);
        resultsContainer.innerHTML = '';

        try {
            const response = await fetch(`/search/Vk?tag=${encodeURIComponent(query)}`);

            const data = await response.json();

            if (!response.ok) {
                showError(data.error || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞');
                return;
            }

            if (!data.length) {
                resultsContainer.innerHTML = `<div class="no-results">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üòï</div>`;
                return;
            }

            data.forEach(item => {
                resultsContainer.appendChild(createResultItem(item));
            });

            // –ü–ª–∞–≤–Ω–æ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
            scrollToResults();

        } catch (err) {
            console.error(err);
            showError('–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –∏–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞');
        } finally {
            toggleLoading(false);
        }
    };

    // –°–ª—É—à–∞—Ç–µ–ª—å –∫–Ω–æ–ø–∫–∏
    searchButton.addEventListener('click', () => {
        const query = searchInput.value.trim();
        if (query.length > 2) {
            performSearch(query);
        } else {
            showError('–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã 3 —Å–∏–º–≤–æ–ª–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞');
        }
    });
</script>
{% endblock %}

{% block content %}
<div class="search-container">
    <input type="text" id="searchInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞...">
    <button id="searchButton">–ü–æ–∏—Å–∫</button>
    <div class="loading-container" id="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div class="results-container" id="results"></div>
</div>
{% endblock %}
